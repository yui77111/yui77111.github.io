---
title: 微信测试接口推送
description: 微信接口推送数据
categories:
 - tools
tags: 
 - 有趣
---

以先知社区推送为例，时时推送最新文章

[接口url](https://mp.weixin.qq.com/debug/cgi-bin/sandbox?t=sandbox/login)

[社区url](https://xz.aliyun.com/)

### 微信登录获取`appID`与`appsecret`

![image-20200716111925314](https://yui77111.github.io/assets/images/article/wechatpush/image-20200716111925314.png)

### 接收推送的微信扫描关注测试公众号，获取关注者的微信`OpenID`

![image-20200716112417023](https://yui77111.github.io/assets/images/article/wechatpush/image-20200716112417023.png)

### 新增测试模板，获取模板ID`template_id`，模板内容格式参数需以.DATA结尾；

想要推送的格式为

```
社区推送
2020-07-31 11:44:01
author/tags

某CMS代码审计

https://xz.aliyun.com/t/xxxx
```

![1594872349](https://yui77111.github.io/assets/images/article/wechatpush/1594872349.jpg)

![1594872255](https://yui77111.github.io/assets/images/article/wechatpush/1594872255.jpg)

### 步骤

需要用到的`appID`、`appsecret`、`OpenID`和`template_id`

获取access_token->获取用户OpenID->获取推送文章->推送



详细可参考开发文档

[获取access_token](https://developers.weixin.qq.com/doc/offiaccount/Basic_Information/Get_access_token.html)

[获取OpenID](https://developers.weixin.qq.com/doc/offiaccount/User_Management/Getting_a_User_List.html)

[发送](https://developers.weixin.qq.com/doc/offiaccount/Message_Management/Template_Message_Interface.html)

### python

获取的access_token有效时间是2个小时，可以将获取的access_token保存到文本时，需要时提取，失效了再重新获取，不然获取太频繁会重置

```python
    def get_access_token(self):
        url = 'https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid={}&secret={}'.format(self.appid,self.appsecret)
        r = request('get',url,headers=self.headers,proxies=self.proxies,verify=False,allow_redirects=False)
        f = open('access_token','w+')
        f.write(loads(r.text)['access_token'])
        f.close()
```

获取`OpenID`

```python
    def get_user_list(self):
        f = open('access_token','r+')
        self.access_token = f.readline()
        url = 'https://api.weixin.qq.com/cgi-bin/user/get?access_token={}&next_openid='.format(self.access_token)
        r = request('get', url,headers=self.headers,proxies=self.proxies,verify=False,allow_redirects=False)
        return loads(text)['data']['openid']
```

获取推送文章，爬虫抓取

```python
{'title': '内网Mysql代理浅析\n', 'author/tag': 'kuron3k0/渗透测试\n', 'url': 'https://xz.aliyun.com//t/7993'}
```

发送的数据为json格式

```python
    def send_msg(self,openid,info,template):
        msg = {
            "touser": openid,
            "template_id": template,
            "url": info['url'],
            "data": {
                'time': {
                    'value': strftime("%Y-%m-%d %H:%M:%S", localtime())
                },
                "author/tag": {
                    "value": info['author/tag'],
                },
                "title": {
                    "value": info['title'],
                },
                "url": {
                    "value": info['url'],
                    "color": "#173177"
                }
            }
        }
        new_msg = dumps(msg, ensure_ascii=False).encode('utf-8', "ignore")
        url = 'https://api.weixin.qq.com/cgi-bin/message/template/send?access_token=' + self.access_token
        r = request('post', url=url, data=new_msg, headers=self.headers, proxies=self.proxies, verify=False,
                    allow_redirects=False)
```

### 效果

<img src="https://yui77111.github.io/assets/images/article/wechatpush/1594884408.jpg" alt="1594884408" style="zoom:50%;" />

<img src="https://yui77111.github.io/assets/images/article/wechatpush/118b9d1c372e5711071e68711da5f3b.jpg" alt="118b9d1c372e5711071e68711da5f3b" style="zoom:19%;" />

### 其他

推送只是微信接口的其中一个功能，想要了解其他功能可以参考开发文档。

脚本循环提取有些网站可能会因访问太频繁而ban了，可以自加代理，这里提供几个代理网址，可以自己提取使用。(http://www.66ip.cn/，http://www.89ip.cn/，https://ip.jiangxianli.com/api/proxy_ip，http://www.data5u.com/，http://www.goubanjia.com/，http://www.xdaili.cn/，https://www.kuaidaili.com/，http://www.ip3366.net/，https://list.proxylistplus.com/)https://blog.csdn.net/qq_40989258/article/details/105344344)